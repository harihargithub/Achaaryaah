<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Player</title>
    <link rel="stylesheet" type="text/css" href="tambola.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
</head>

<body>
    <h1>Tambola Ticket</h1>
    <div id="ticket" class="ticket"></div>
    <p id="message"></p> <!-- To display any messages or errors -->

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBZAVFIJV9W_A4W7lh07Ikt2-oeNuMwJhQ",
            authDomain: "tambola-db7bb.firebaseapp.com",
            databaseURL: "https://tambola-db7bb-default-rtdb.firebaseio.com",
            projectId: "tambola-db7bb",
            storageBucket: "tambola-db7bb.appspot.com",
            messagingSenderId: "689800248387",
            appId: "1:689800248387:web:68767bd47485bdf7d828f6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Function to load the player's ticket
        function loadPlayerTicket() {
            const urlParams = new URLSearchParams(window.location.search);
            const playerId = urlParams.get('playerId'); // Get playerId from the URL
            const messageElement = document.getElementById('message');

            // Check if playerId is provided
            if (!playerId) {
                messageElement.textContent = 'Player ID not found. Please check the link or contact the manager.';
                return;
            }

            // Clear punched numbers from local storage
            localStorage.removeItem(`punchedNumbers-${playerId}`);

            // Retrieve the ticket from Firebase
            const ticketKey = `playerTickets/${playerId}`;
            database.ref(ticketKey).once('value').then((snapshot) => {
                const ticket = snapshot.val();
                console.log(`Loaded ticket for key "${ticketKey}":`, ticket); // Debugging

                // Check if the ticket exists
                if (!ticket) {
                    messageElement.textContent = `Ticket for Player ${playerId} not found. Please contact the manager.`;
                    return;
                }

                // Display the ticket
                const ticketDiv = document.getElementById('ticket');
                ticket.forEach((num) => {
                    const div = document.createElement('div');
                    div.classList.add('cell');

                    // Display the number or leave the cell empty
                    div.textContent = num !== '' ? num : ''; // Empty string for blank cells
                    if (num !== '') div.id = `ticket-${playerId}-${num}`; // Assign an ID to each cell

                    // Allow punching only if the cell has a number
                    if (num !== '') {
                        div.onclick = () => punchNumber(playerId, num, div);
                    }

                    ticketDiv.appendChild(div);
                });
            });
        }

        // Function to punch a number on the ticket
        function punchNumber(playerId, num, cell) {
            database.ref('calledNumbers').once('value').then((snapshot) => {
                const calledNumbers = snapshot.val() || [];
                if (calledNumbers.includes(num)) {
                    cell.classList.add('punched'); // Highlight punched numbers
                    // Store punched numbers in local storage
                    let punchedNumbers = JSON.parse(localStorage.getItem(`punchedNumbers-${playerId}`)) || [];
                    if (!punchedNumbers.includes(num)) {
                        punchedNumbers.push(num);
                        localStorage.setItem(`punchedNumbers-${playerId}`, JSON.stringify(punchedNumbers));
                    }
                } else {
                    alert('This number has not been called yet!');
                }
            });
        }

        // Sync called numbers from Firebase in real-time
        function syncCalledNumbers(playerId) {
            database.ref('calledNumbers').on('value', (snapshot) => {
                const calledNumbers = snapshot.val() || [];
                calledNumbers.forEach((num) => {
                    const numberElement = document.getElementById(`ticket-${playerId}-${num}`);
                    if (numberElement) {
                        numberElement.classList.add('punched');
                    }
                });
            });
        }

        // Initialize the player ticket and sync updates
        (function init() {
            loadPlayerTicket();

            // Get playerId for syncing called numbers
            const urlParams = new URLSearchParams(window.location.search);
            const playerId = urlParams.get('playerId');
            if (playerId) {
                syncCalledNumbers(playerId);
            }
        })();
    </script>
</body>

</html>